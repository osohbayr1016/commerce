"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[9971],{52503:(e,t,r)=>{r.d(t,{CartProvider:()=>h,_:()=>f});var a=r(95155),i=r(12115),n=r(65380);async function o(e){try{for(let t of e)await c(t.id,t.quantity,t.size)}catch(e){}}async function s(){try{let e=await fetch("/api/cart");if(!e.ok)return[];return(await e.json()).items||[]}catch(e){return[]}}async function c(e,t,r){try{return(await fetch("/api/cart",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({product_id:e,quantity:t,size:r||null})})).ok}catch(e){return!1}}async function l(e,t,r){try{return(await fetch("/api/cart",{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({product_id:e,quantity:t,size:r||null})})).ok}catch(e){return!1}}async function u(e,t){try{let r=new URL("/api/cart",window.location.origin);return r.searchParams.set("product_id",e),t&&r.searchParams.set("size",t.toString()),(await fetch(r.toString(),{method:"DELETE"})).ok}catch(e){return!1}}let d=(0,i.createContext)(void 0);function h(e){let{children:t}=e,{user:r}=(0,n.A)(),[h,f]=(0,i.useState)([]),[p,y]=(0,i.useState)(!1),[w,m]=(0,i.useState)(!1),S=(0,i.useRef)(null),g=(0,i.useRef)(!0),E=r?"cart:".concat(r.id):"cart:guest";(0,i.useEffect)(()=>{if(!E)return void f([]);(async()=>{y(!0);try{let e=[];if(r)try{e=await s()}catch(e){console.error("Failed to fetch server cart",e)}let t=localStorage.getItem(E),a=[];try{let e=t?JSON.parse(t):[];Array.isArray(e)&&(a=e)}catch(e){console.error("Error parsing cart from localStorage",e),a=[]}let i=r?[...Array.isArray(e)?e:[]]:[...a];r&&a.forEach(e=>{i.find(t=>t.id===e.id&&t.size===e.size)||i.push(e)}),f(i),localStorage.setItem(E,JSON.stringify(i)),r&&a.length>0&&e.length!==i.length&&await o(i)}catch(t){let e=localStorage.getItem(E);f(e?JSON.parse(e):[])}finally{y(!1),g.current=!1}})()},[r,E]),(0,i.useEffect)(()=>{E&&!g.current&&localStorage.setItem(E,JSON.stringify(h))},[h,E]),(0,i.useEffect)(()=>{if(E&&!g.current&&r)return S.current&&clearTimeout(S.current),S.current=setTimeout(async()=>{y(!0);try{for(let e of h)await c(e.id,e.quantity,e.size)}catch(e){}finally{y(!1)}},1e3),()=>{S.current&&clearTimeout(S.current)}},[h,r,E]);let I=async function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;try{let r=await fetch("/api/products/".concat(e.id,"/stock"));if(r.ok){var a;let i=await r.json(),n=((null==(a=h.find(t=>t.id===e.id&&t.size===e.size))?void 0:a.quantity)||0)+t;if(i.stock<n)return{ok:!1,error:0===i.stock?"Бэлэн бараа байхгүй":"Зөвхөн ".concat(i.stock," ширхэг үлдсэн")}}}catch(e){}if(f(r=>r.find(t=>t.id===e.id&&t.size===e.size)?r.map(r=>r.id===e.id&&r.size===e.size?{...r,quantity:r.quantity+t}:r):[...r,{...e,quantity:t}]),r)try{await c(e.id,t,e.size)}catch(e){}return m(!0),{ok:!0}},A=async(e,t)=>{let a=Math.max(1,t),i=h.find(t=>t.id===e);try{let t=await fetch("/api/products/".concat(e,"/stock"));if(t.ok){let n=await t.json();if(n.stock<a){let t=Math.min(n.stock,a);f(r=>r.map(r=>r.id===e?{...r,quantity:t}:r)),i&&r&&await l(e,t,i.size);return}}}catch(e){}if(f(t=>t.map(t=>t.id===e?{...t,quantity:a}:t)),i&&r)try{await l(e,a,i.size)}catch(e){}},b=async e=>{let t=h.find(t=>t.id===e);if(f(t=>t.filter(t=>t.id!==e)),t&&r)try{await u(e,t.size)}catch(e){}},v=async()=>{if(r)try{for(let e of h)await u(e.id,e.size)}catch(e){}f([])},N=(0,i.useMemo)(()=>(h||[]).reduce((e,t)=>e+t.price*t.quantity,0),[h]),P=(0,i.useMemo)(()=>(h||[]).reduce((e,t)=>e+t.quantity,0),[h]);return(0,a.jsx)(d.Provider,{value:{items:h,subtotal:N,totalItems:P,addItem:I,updateQuantity:A,removeItem:b,clearCart:v,syncing:p,isDrawerOpen:w,openDrawer:()=>m(!0),closeDrawer:()=>m(!1)},children:t})}function f(){let e=(0,i.useContext)(d);if(!e)throw Error("useCart must be used within a CartProvider");return e}},64269:(e,t,r)=>{function a(e,t){let r=e.toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/(^-|-$)/g,"");if(t){let e=t.replace(/[^a-z0-9]+/gi,"-").toLowerCase();return"".concat(r,"-").concat(e)}return r}function i(e){return new Intl.NumberFormat("mn-MN").format(e)}r.d(t,{$:()=>i,z:()=>a})},65380:(e,t,r)=>{r.d(t,{A:()=>c,AuthProvider:()=>s});var a=r(95155),i=r(12115),n=r(96648);let o=(0,i.createContext)(void 0);function s(e){let{children:t}=e,[r,s]=(0,i.useState)(null),[c,l]=(0,i.useState)(null),[u,d]=(0,i.useState)(!0),h=(0,n.U)();(0,i.useEffect)(()=>{let e,t="https://ejdwrepyuznanwujidai.supabase.co";if(!t||t.includes("placeholder")){console.error("Supabase not configured. Please set NEXT_PUBLIC_SUPABASE_URL and NEXT_PUBLIC_SUPABASE_ANON_KEY in Cloudflare Dashboard."),d(!1);return}h.auth.getSession().then(e=>{var t;let{data:{session:r}}=e;s(null!=(t=null==r?void 0:r.user)?t:null),(null==r?void 0:r.user)?f(r.user.id):d(!1)}).catch(e=>{console.error("Auth: Failed to get session",e),d(!1)});try{let{data:{subscription:t}}=h.auth.onAuthStateChange((e,t)=>{var r;s(null!=(r=null==t?void 0:t.user)?r:null),(null==t?void 0:t.user)?f(t.user.id):(l(null),d(!1))});e=t}catch(e){console.error("Auth: Failed to set up auth state listener",e),d(!1)}return()=>{e&&e.unsubscribe()}},[]);let f=async e=>{try{let{data:t,error:r}=await h.from("profiles").select("*").eq("id",e).single();if(r)throw r;l(t)}catch(e){}finally{d(!1)}},p=async(e,t,r,a)=>{let i=t.replace(/[^0-9]/g,""),{data:n,error:o}=await h.auth.signUp({email:e,password:r,options:{data:{full_name:a||"",phone_number:i},emailRedirectTo:void 0}});if(o){if(o.message.includes("Signups not allowed"))throw Error('Бүртгэл идэвхгүй байна. Суpabase dashboard-аас "Enable email signups" асаах шаардлагатай. Authentication → Providers → Email → Enable email signups');throw o}n.user&&(s(n.user),await f(n.user.id))},y=async(e,t)=>{let r;if(e.includes("@"))r=e.trim();else{let t=e.replace(/[^0-9]/g,"");if(!t||t.length<8)throw Error("Утасны дугаар буруу байна");let{data:a,error:i}=await h.from("profiles").select("email").eq("phone_number",t).single();if(i)throw Error("Утасны дугаараар бүртгэл олдсонгүй. И-мэйл ашиглана уу.");if(!(null==a?void 0:a.email))throw Error("Бүртгэлийн мэдээлэл дутуу байна. Та дахин бүртгүүлнэ үү.");r=a.email}let{data:a,error:i}=await h.auth.signInWithPassword({email:r,password:t});if(i)throw i},w=async()=>{let{data:e,error:t}=await h.auth.signInWithOAuth({provider:"google",options:{redirectTo:"".concat(window.location.origin,"/auth/callback")}});if(t)throw t},m=async()=>{let{data:e,error:t}=await h.auth.signInWithOAuth({provider:"facebook",options:{redirectTo:"".concat(window.location.origin,"/auth/callback")}});if(t)throw t},S=async()=>{let{error:e}=await h.auth.signOut();if(e)throw e},g=async()=>{r&&await f(r.id)},E=(null==c?void 0:c.role)==="admin";return(0,a.jsx)(o.Provider,{value:{user:r,profile:c,loading:u,signUp:p,signIn:y,signInWithGoogle:w,signInWithFacebook:m,signOut:S,refreshProfile:g,isAdmin:E},children:t})}function c(){let e=(0,i.useContext)(o);if(void 0===e)throw Error("useAuth must be used within an AuthProvider");return e}},96648:(e,t,r)=>{r.d(t,{U:()=>s});var a=r(55417);let i="https://ejdwrepyuznanwujidai.supabase.co",n="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVqZHdyZXB5dXpuYW53dWppZGFpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgzNjk3NTYsImV4cCI6MjA4Mzk0NTc1Nn0.MRJe6csColzMRDpAWa-Ma99noAk6n8SbnXXHP2rNAJ4",o=null;function s(){!i||i.includes("placeholder")||i.includes("MISSING")?console.error("❌ Supabase configuration missing!\n\nNEXT_PUBLIC_SUPABASE_URL is not set.\n\nTo fix this:\n1. Go to Cloudflare Dashboard → Workers & Pages → Your Project\n2. Settings → Environment variables\n3. Add NEXT_PUBLIC_SUPABASE_URL with your Supabase project URL\n\nSee DEPLOYMENT.md for detailed instructions."):(!n||n.includes("placeholder")||n.includes("MISSING"))&&console.error("❌ Supabase configuration missing!\n\nNEXT_PUBLIC_SUPABASE_ANON_KEY is not set.\n\nTo fix this:\n1. Go to Cloudflare Dashboard → Workers & Pages → Your Project\n2. Settings → Environment variables\n3. Add NEXT_PUBLIC_SUPABASE_ANON_KEY with your Supabase anon key\n\nSee DEPLOYMENT.md for detailed instructions.");let e=!i||i.includes("placeholder")||i.includes("MISSING")?"https://placeholder.supabase.co":i,t=!n||n.includes("placeholder")||n.includes("MISSING")?"placeholder-key":n;return o||(o=(0,a.createBrowserClient)(e,t)),o}}}]);